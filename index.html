<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iEditWeb</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/editor.css">
    <link rel="stylesheet" href="styles/flowchart.css">
    <link rel="stylesheet" href="styles/search.css">
    <link rel="stylesheet" href="styles/settings.css">
    <script>
        // Service Worker cleanup (if needed for debugging)
        if (window.location.hostname === 'localhost') {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister();
                    console.log('Service Worker unregistered.');
                }
            });
        }
    </script>
    <script src="assets/lib/jszip.min.js"></script>
    <script src="assets/lib/FileSaver.min.js"></script>
</head>

<body>

    <!-- Header -->
    <header id="toolbar">
        <div id="toggleSidebar" title="サイドバー切り替え">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z" />
            </svg>
        </div>
        <div id="filename">無題のドキュメント</div>
        <div class="header-controls">
            <button id="searchBtn" title="検索 (Ctrl+F)">
                <svg class="icon" viewBox="0 0 24 24">
                    <path
                        d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
                </svg>
            </button>
            <button id="settingsBtn" title="設定">
                <svg class="icon" viewBox="0 0 24 24">
                    <path
                        d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.35 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.35 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
            <button id="saveBtn" title="保存 (Ctrl+S)">
                <svg class="icon" viewBox="0 0 24 24">
                    <path
                        d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
                </svg>
            </button>
            <button id="loadBtn" title="読み込み">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
            </button>
        </div>
    </header>

    <div id="container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div id="resizer"></div>
            <div class="sidebar-section">
                <h3>アウトライン</h3>
                <div id="outline-list"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Flowchart Area -->
            <div id="flowchart-container">
                <div class="flowchart-toolbar">
                    <button class="mode-btn active" data-mode="select" title="選択">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M7,2V11H9V13H7V22H17V13H15V11H17V2H7M9,4H15V9H9V4M9,15H15V20H9V15Z" />
                        </svg>
                    </button>
                    <button class="mode-btn" data-mode="connect" title="接続">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12.71,4.22C14.66,2.27 17.83,2.27 19.78,4.22C21.73,6.17 21.73,9.34 19.78,11.29L18.29,12.78C18.3,11.96 18.17,11.14 17.89,10.36L18.36,9.88C19.54,8.71 19.54,6.81 18.36,5.64C17.19,4.46 15.29,4.46 14.12,5.64L10.59,9.17C9.41,10.34 9.41,12.24 10.59,13.41M13.41,9.17C13.8,8.78 14.44,8.78 14.83,9.17C16.78,11.12 16.78,14.29 14.83,16.24V16.24L11.29,19.78C9.34,21.73 6.17,21.73 4.22,19.78C2.27,17.83 2.27,14.66 4.22,12.71L5.71,11.22C5.7,12.04 5.83,12.86 6.11,13.64L5.64,14.12C4.46,15.29 4.46,17.19 5.64,18.36C6.81,19.54 8.71,19.54 9.88,18.36L13.41,14.83C14.59,13.66 14.59,11.76 13.41,10.59C13,10.2 13,9.56 13.41,9.17Z" />
                        </svg>
                    </button>
                    <button class="mode-btn" data-mode="pan" title="移動">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M23,5.5V20C23,22.2 21.2,24 19,24H10C7.8,24 6,22.2 6,20V19H5V18H6V14.5L4.2,16.3C3.8,16.7 3.2,16.7 2.8,16.3L2.1,15.6L8.1,9.6C8.5,9.2 9,9 9.5,9H10V5.5C10,4.7 10.7,4 11.5,4C12.3,4 13,4.7 13,5.5V9H14V5.5C14,4.7 14.7,4 15.5,4C16.3,4 17,4.7 17,5.5V9H18V5.5C18,4.7 18.7,4 19.5,4C20.3,4 21,4.7 21,5.5V9H22V5.5C22,4.7 22.7,4 23.5,4C24.3,4 25,4.7 25,5.5H23M13,2H11V0H13V2M17,2H15V0H17V2M21,2H19V0H21V2Z" />
                        </svg>
                    </button>
                </div>

                <div id="flowchart-canvas">
                    <div id="canvas-content">
                        <svg id="connections-layer">
                            <defs>
                                <marker id="arrow-head" markerWidth="10" markerHeight="10" refX="10" refY="5"
                                    orient="auto">
                                    <path d="M0,0 L10,5 L0,10" fill="#94a3b8" />
                                </marker>
                                <marker id="arrow-head-selected" markerWidth="10" markerHeight="10" refX="10" refY="5"
                                    orient="auto">
                                    <path d="M0,0 L10,5 L0,10" fill="#3b82f6" />
                                </marker>
                            </defs>
                        </svg>
                        <div id="shapes-layer"></div>
                    </div>
                </div>
            </div>

            <div id="vertical-resizer"></div>

            <!-- Editor Area -->
            <div id="editor-container">
                <div id="editor" contenteditable="true" spellcheck="false">
                    <h1>ここにタイトルを入力...</h1>
                    <p>本文をここに入力してください。</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Floating Toolbar -->
    <div id="float-toolbar" class="hidden">
        <button data-cmd="bold" title="太字"><svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M13.5,15.5H10V12.5H13.5A1.5,1.5 0 0,1 15,14A1.5,1.5 0 0,1 13.5,15.5M10,6.5H13A1.5,1.5 0 0,1 14.5,8A1.5,1.5 0 0,1 13,9.5H10M15.6,10.79C16.57,10.11 17.25,9.02 17.25,8C17.25,5.74 15.5,4 13.25,4H7V18H14.04C16.14,18 17.75,16.3 17.75,14.21C17.75,12.69 16.89,11.39 15.6,10.79Z" />
            </svg></button>
        <button data-cmd="italic" title="斜体"><svg class="icon" viewBox="0 0 24 24">
                <path d="M10,4V7H12.21L8.79,15H6V18H14V15H11.79L15.21,7H18V4H10Z" />
            </svg></button>
        <button data-cmd="underline" title="下線"><svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M5,21H19V19H5V21M12,17A6,6 0 0,0 18,11V3H15.5V11A3.5,3.5 0 0,1 12,14.5A3.5,3.5 0 0,1 8.5,11V3H6V11A6,6 0 0,0 12,17Z" />
            </svg></button>
        <div class="separator"></div>
        <button data-cmd="insertUnorderedList" title="箇条書き"><svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M7,5H21V7H7V5M7,13V11H21V13H7M4,4.5A1.5,1.5 0 0,1 5.5,6A1.5,1.5 0 0,1 4,7.5A1.5,1.5 0 0,1 2.5,6A1.5,1.5 0 0,1 4,4.5M4,10.5A1.5,1.5 0 0,1 5.5,12A1.5,1.5 0 0,1 4,13.5A1.5,1.5 0 0,1 2.5,12A1.5,1.5 0 0,1 4,10.5M7,19V17H21V19H7M4,16.5A1.5,1.5 0 0,1 5.5,18A1.5,1.5 0 0,1 4,19.5A1.5,1.5 0 0,1 2.5,18A1.5,1.5 0 0,1 4,16.5Z" />
            </svg></button>
        <button data-cmd="insertOrderedList" title="番号付きリスト"><svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M7,13V11H21V13H7M7,19V17H21V19H7M7,7V5H21V7H7M3,8V5H2V4H4V8H3M2,17V16H5V20H2V19H4V18.5H3V17.5H4V17H2M4.25,10A0.75,0.75 0 0,1 5,10.75C5,10.95 4.92,11.14 4.79,11.27L3.12,13H5V14H2V13.08L4,11H2V10H4.25Z" />
            </svg></button>
        <div class="separator"></div>
        <select id="formatBlockSelect">
            <option value="p">テキスト</option>
            <option value="h1">見出し 1</option>
            <option value="h2">見出し 2</option>
            <option value="h3">見出し 3</option>
            <option value="h4">見出し 4</option>
            <option value="blockquote">引用</option>
        </select>
        <div class="separator"></div>
        <button id="textColorBtn" title="文字色">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M9.62,12L12,5.67L14.37,12M11,3L5.5,17H7.75L8.87,14H15.12L16.25,17H18.5L13,3H11Z" />
            </svg>
        </button>
        <button id="highlightBtn" title="背景色">
            <svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M18.5,1.15C17.97,1.15 17.46,1.34 17.07,1.73L11.26,7.55L16.91,13.2L22.73,7.39C23.5,6.61 23.5,5.35 22.73,4.56L19.89,1.73C19.5,1.34 19,1.15 18.5,1.15M10.3,8.5L4.34,14.46C3.56,15.24 3.56,16.5 4.36,17.31C3.14,18.54 1.9,19.77 0.67,21H6.33L7.19,20.14C7.97,20.9 9.22,20.89 10,20.12L15.95,14.16" />
            </svg>
        </button>
        <div class="separator"></div>
        <button id="rubyBtn" title="ルビ">
            <span style="font-weight: bold; font-size: 12px;">ルビ</span>
        </button>
        <button id="codeBtn" title="コード">
            <svg class="icon" viewBox="0 0 24 24">
                <path
                    d="M14.6,16.6L19.2,12L14.6,7.4L16,6L22,12L16,18L14.6,16.6M9.4,16.6L4.8,12L9.4,7.4L8,6L2,12L8,18L9.4,16.6Z" />
            </svg>
        </button>
    </div>

    <!-- Color Picker -->
    <div id="textColorPicker" class="color-picker hidden"></div>
    <div id="highlightPicker" class="color-picker hidden"></div>

    <!-- Search Panel -->
    <div id="search-panel" class="hidden">
        <div class="search-row">
            <input type="text" id="search-input" placeholder="検索...">
            <button id="find-prev-btn" title="前へ">↑</button>
            <button id="find-next-btn" title="次へ">↓</button>
            <button id="close-search-btn" title="閉じる">×</button>
        </div>
        <div class="search-row">
            <input type="text" id="replace-input" placeholder="置換...">
            <button id="replace-btn">置換</button>
            <button id="replace-all-btn">すべて置換</button>
        </div>
        <div class="search-info" id="search-info"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden">
        <div class="settings-content">
            <div class="settings-header">
                <h2>設定</h2>
                <button id="close-settings-btn" class="close-btn">×</button>
            </div>
            <div class="settings-body">
                <div class="setting-item">
                    <label>テーマ</label>
                    <select id="theme-select">
                        <option value="light">ライト</option>
                        <option value="dark">ダーク</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>プライマリーカラー</label>
                    <input type="color" id="primary-color-picker" value="#0d9488">
                </div>
                <div class="setting-item">
                    <label>フォント</label>
                    <select id="font-select">
                        <option value="sans-serif">ゴシック体 (Sans-serif)</option>
                        <option value="serif">明朝体 (Serif)</option>
                        <option value="monospace">等幅 (Monospace)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>フォントサイズ (px)</label>
                    <input type="number" id="font-size-input" value="16" min="10" max="32">
                </div>
                <div class="setting-item">
                    <label>エディタ背景色</label>
                    <input type="color" id="editor-bg-color" value="#ffffff">
                </div>
                <div class="setting-item">
                    <label>文字色</label>
                    <input type="color" id="editor-text-color" value="#334155">
                </div>
                <div class="settings-footer">
                    <button id="save-settings-btn" class="primary-btn">保存して適用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flowchart Context Menu -->
    <div id="flowchart-context-menu" class="context-menu hidden">
        <!-- シェイプ用の編集フォーム -->
        <div id="shape-edit-section" class="context-menu-section">
            <div class="context-menu-title">ノード スタイル</div>
            <div class="context-menu-form">
                <div class="context-menu-row">
                    <label>背景色</label>
                    <input type="color" id="ctx-shape-bg" value="#ffffff">
                </div>
                <div class="context-menu-row">
                    <label>枠線色</label>
                    <input type="color" id="ctx-shape-border" value="#cbd5e1">
                </div>
                <div class="context-menu-row">
                    <label>文字色</label>
                    <input type="color" id="ctx-shape-text" value="#334155">
                </div>
            </div>
        </div>

        <!-- 接続線用の編集フォーム -->
        <div id="connection-edit-section" class="context-menu-section hidden">
            <div class="context-menu-title">線 スタイル</div>
            <div class="context-menu-form">
                <div class="context-menu-row">
                    <label>スタイル</label>
                    <select id="ctx-connection-style">
                        <option value="solid">実線</option>
                        <option value="dashed">点線</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="context-menu-separator"></div>
        <div class="context-menu-item delete" data-action="delete">削除</div>
    </div>

    <!-- Flowchart Property Panel -->
    <div id="flowchart-properties" class="property-panel hidden">
        <h4>プロパティ</h4>
        <div class="prop-group">
            <label>背景色</label>
            <input type="color" id="shapeBgColor">
        </div>
        <div class="prop-group">
            <label>枠線色</label>
            <input type="color" id="shapeBorderColor">
        </div>
        <div class="prop-group">
            <label>文字色</label>
            <input type="color" id="shapeTextColor">
        </div>
        <div class="prop-group">
            <label>接続スタイル</label>
            <select id="connectionStyle">
                <option value="solid">実線</option>
                <option value="dashed">点線</option>
            </select>
        </div>
    </div>

    <script type="module" src="src/main.js?v=2"></script>
</body>

</html>